name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string

jobs:
  build-and-release:
    name: Build and Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Run tests
        run: npm test -- --ci
        
      - name: Build plugin
        run: npm run build
        
      - name: Create plugin package
        run: |
          mkdir -p figma-design-lint
          cp -r dist/* figma-design-lint/
          cp manifest.json figma-design-lint/
          cp README.md figma-design-lint/
          zip -r figma-design-lint.zip figma-design-lint
          
      - name: Generate changelog
        id: changelog
        run: |
          echo "## What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          # Get commit messages since last tag
          if [ -z "$(git tag)" ]; then
            git log --pretty=format:"* %s (%h)" >> CHANGELOG.md
          else
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$LAST_TAG" ]; then
              git log ${LAST_TAG}..HEAD --pretty=format:"* %s (%h)" >> CHANGELOG.md
            else
              git log --pretty=format:"* %s (%h)" >> CHANGELOG.md
            fi
          fi
          echo "" >> CHANGELOG.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")...${{ github.ref_name }}" >> CHANGELOG.md
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body_path: CHANGELOG.md
          files: |
            figma-design-lint.zip
            dist/*.js
            dist/*.html
          draft: false
          prerelease: ${{ contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          generate_release_notes: true
          
  publish-to-figma:
    name: Publish to Figma Community
    runs-on: ubuntu-latest
    needs: build-and-release
    if: ${{ !contains(github.ref_name, '-beta') && !contains(github.ref_name, '-alpha') }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Build plugin
        run: npm run build
        
      - name: Generate release notes
        id: release_notes
        run: |
          # Extract version number
          VERSION="${{ github.ref_name }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          # Generate release notes
          NOTES="## Version $VERSION\n\n"
          
          # Get commit messages since last tag
          if [ -z "$(git tag)" ]; then
            NOTES+=$(git log --pretty=format:"- %s" | head -10)
          else
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$LAST_TAG" ]; then
              NOTES+=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" | head -10)
            else
              NOTES+=$(git log --pretty=format:"- %s" | head -10)
            fi
          fi
          
          # Save to file for the action
          echo -e "$NOTES" > release-notes.txt
          
      - name: Extract Plugin Info from manifest
        id: plugin_info
        run: |
          PLUGIN_ID=$(jq -r '.id' manifest.json)
          TEAM_ID=$(jq -r '.teamId // empty' manifest.json)
          echo "plugin_id=$PLUGIN_ID" >> $GITHUB_OUTPUT
          echo "team_id=$TEAM_ID" >> $GITHUB_OUTPUT
          echo "Plugin ID: $PLUGIN_ID"
          echo "Team ID: $TEAM_ID"
          
      - name: Deploy to Figma
        id: deploy
        uses: typper-io/figma-plugin-deploy@v1
        with:
          plugin-id: ${{ steps.plugin_info.outputs.plugin_id }}
          team-id: ${{ steps.plugin_info.outputs.team_id }}
          release-notes-file: release-notes.txt
        env:
          FIGMA_EMAIL: ${{ secrets.FIGMA_EMAIL }}
          FIGMA_PASSWORD: ${{ secrets.FIGMA_PASSWORD }}
          FIGMA_TOTP_SECRET: ${{ secrets.FIGMA_TOTP_SECRET || '' }}
        continue-on-error: true # Don't fail the workflow if deployment fails
        
      - name: Deployment Status
        if: always()
        run: |
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "✅ Plugin successfully deployed to Figma Community!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Automated deployment failed. Manual publishing required." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 📦 Manual Publishing Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Download the release assets from the release page" >> $GITHUB_STEP_SUMMARY
            echo "2. Go to Figma Plugin publish/update page" >> $GITHUB_STEP_SUMMARY
            echo "3. Upload the new version" >> $GITHUB_STEP_SUMMARY
            echo "4. Update the version notes with the changelog" >> $GITHUB_STEP_SUMMARY
            echo "5. Submit for review" >> $GITHUB_STEP_SUMMARY
          fi